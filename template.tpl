___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook CAPI Server Tag",
  "brand": {
    "thumbnail": "data:image/jpeg;base64,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",
    "displayName": "peaksandpies",
    "id": "github.com_peaksandpies"
  },
  "description": "A server-side tag template that sends data from your tagging server to Facebookâ€™s CAPI.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "To use the Conversions API, you need an access token. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/get-started#access-token\"\u003ehere\u003c/a\u003e for generating an access token."
  },
  {
    "type": "TEXT",
    "name": "testEventCode",
    "displayName": "Test Event Code",
    "simpleValueType": true,
    "help": "Code used to verify that your server events are received correctly by Facebook. Use this code to test your server events in the Test Events feature in Events Manager. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/using-the-api#testEvents\"\u003e Test Events Tool\u003c/a\u003e for an example."
  },
  {
    "type": "SELECT",
    "name": "actionSource",
    "displayName": "Action Source",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "website",
        "displayValue": "Website"
      },
      {
        "value": "email",
        "displayValue": "Email"
      },
      {
        "value": "app",
        "displayValue": "App"
      },
      {
        "value": "phone_call",
        "displayValue": "Phone Call"
      },
      {
        "value": "chat",
        "displayValue": "Chat"
      },
      {
        "value": "physical_store",
        "displayValue": "Physical Store"
      },
      {
        "value": "system_generated",
        "displayValue": "System Generated"
      },
      {
        "value": "other",
        "displayValue": "Other"
      }
    ],
    "simpleValueType": true,
    "help": "This field allows you to specify where your conversions occurred. Knowing where your events took place helps ensure your ads go to the right people. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/server-event#action-source\"\u003ehere\u003c/a\u003e for more information."
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const getCookieValues = require('getCookieValues');
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const Math = require('Math');
const sendHttpRequest = require('sendHttpRequest');

const GRAPH_BASE = 'https://graph.facebook.com/v11.0/';
const GRAPH_ENDPOINT = '/events';
const PARTNER_AGENT = 'pp_capi';

const eventModel = getAllEventData();
const event = {};

event.event_name = eventModel.event_name;
event.event_source_url = eventModel.page_location;
event.custom_data = eventModel.customData;
event.event_time = eventModel.event_time || (Math.round(getTimestampMillis() / 1000));
event.action_source = data.actionSource;
event.event_id = eventModel.event_id;

event.user_data = {
  fbc: eventModel.fbc || getCookieValues('_fbc', true)[0],
  fbp: eventModel.fbp || getCookieValues('_fbp', true)[0]
};

if(eventModel.anonymize_ip != true) {
  event.user_data.client_ip_address = eventModel.ip_override;
}

if(eventModel.anonymize_user_agent != true) {
  event.user_data.client_user_agent = eventModel.user_agent;
}

const request = {
  data: [event],
  partner_agent: PARTNER_AGENT
};

if(data.testEventCode) {
  request.test_event_code = data.testEventCode;
}

const url = GRAPH_BASE + eventModel.pixelId + GRAPH_ENDPOINT + '?access_token=' + data.accessToken;
const options = {
  headers: {
    'Content-Type': 'application/json'
  },
  method: 'POST'
};
const payload = JSON.stringify(request);

sendHttpRequest(url, (statusCode, headers, response) => {
    if(statusCode >= 200 && statusCode < 300) {
      return data.gtmOnSuccess();
    }
    
    data.gtmOnFailure();
  },
  options,
  payload
);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://graph.facebook.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 8/5/2020, 10:20:28 AM


